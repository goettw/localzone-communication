<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Localzone Stream</title>
<script src="sockjs-0.3.4.js"></script>
<script src="stomp.js"></script>

<link rel="stylesheet"
	href="//code.jquery.com/ui/1.11.2/themes/smoothness/jquery-ui.css" />
<script src="//code.jquery.com/jquery-1.10.2.js"></script>
<script src="//code.jquery.com/ui/1.11.2/jquery-ui.js"></script>
<script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
<script th:replace="fragments/googlemaps :: googlemapsheader" />

<link rel="stylesheet" href="bootstrap/css/bootstrap.min.css" />
<link rel="stylesheet" href="css/styles.css" />
<link rel="stylesheet" href="css/boom.css" />
<link rel="stylesheet"
	href="//netdna.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.css" />


<link rel="stylesheet" href="css/localstyles.css" />
<link rel="stylesheet" href="css/social.min.css" />


<script>
	//<![CDATA[
	$(function() {
		$("#slider").slider({
			// orientation: "vertical",
			range : "min",
			min : 0.5,
			max : 5.6,
			value : 3,
			step : 0.1,
			slide : function(event, ui) {
				$("#amount").text(ui.value);
			}
		});

		$("#amount").text($("#slider").slider("value"));

		$("#slider").on("slide", function(event, ui) {
			$("#amount").text(ui.value);
			clearRectangles();
			drawCircle(posLatitude, posLongitude, ui.value * 1000);
			showMessages(ui.value);
		});
	});

	//]]>
</script>
<script type="text/javascript">
	//<![CDATA[
	var posLongitude;
	var posLatitude;
	var accuracy;

	google.maps.event.addDomListener(window, 'load', initialize);

	function initialize() {
		if (navigator.geolocation) {
			navigator.geolocation.getCurrentPosition(callback);
		} else {
			error('not supported');
		}
	}
	function showMessage(message) {
		var response = document.getElementById('response');
		var p = document.createElement('p');
		p.style.wordWrap = 'break-word';
		// p.appendChild(document.createTextNode(body));
		newdiv = $(".message:last").clone();
		$(newdiv).find(".body").html(message.status);
		$(newdiv).find(".author").html(message.from);
		$(newdiv).find(".time").html(message.time);
		$(newdiv).find(".distance").html(message.distance);

		$("#conversationDiv").prepend(newdiv);
		//response.appendChild(p);
	}

	function showlocation() {
		// One-shot position request.
		navigator.geolocation.getCurrentPosition(callback);
	}

	function callback(position) {
		document.getElementById('latitude').innerHTML = position.coords.latitude;
		document.getElementById('longitude').innerHTML = position.coords.longitude;
		posLatitude = position.coords.latitude;
		posLongitude = position.coords.longitude;
		posAccuracy = position.coords.accuracy;
		initializeMap(posLatitude, posLongitude, 11);
		var radius = $("#amount").html();
		drawCircle(posLatitude, posLongitude, radius * 1000);
		showMessages(radius);
	}

	function showMessages(radius) {
		var query = {
			location : {
				'latitude' : posLatitude,
				'longitude' : posLongitude,
				'accuracy' : posAccuracy
			},
			radius : radius,
		};
		$.ajax({
			type : "POST",
			url : "restReceive",
			Accept : "application/json",
			contentType : "application/json",
			data : JSON.stringify(query)
		}).done(function(msg) {
			var conversationDiv = document.getElementById('conversationDiv');
			while (conversationDiv.firstChild) {
				//The list is LIVE so it will re-index each call
				conversationDiv.removeChild(conversationDiv.firstChild);
			}
			//var jsonData = JSON.parse(msg);
			for (var i = 0; i < msg.length; i++) {
				var message = msg[i];
				console.log(message.status);
				showMessage(message);
			}
		});

	}
	//]]>
</script>
</head>
<body>
	<div data-ui-view="" autoscroll="false" class="ng-scope">
		<div th:replace="fragments/header :: header">test</div>
		<div id="wrapper" class="ng-scope active">


			<div id="main-wrapper" class="col-sm-12">
				<div id="main">
					<div class="container-fluid">

						<div class="row margin-top-15 margin-bottom-15">
							<div class="col-md-3">
								<div class="row">
									<div class="col-md-12" id="map-canvas"></div>
								</div>
								<div class="row">
									<div class="col-md-12">
										<div class="well">
											Radius (km):

											<SPAN id="amount" 
												style="border: 0; color: #f6931f; font-weight: bold;" ></SPAN>

											<div id="slider"></div>

										</div>

									</div>
								</div>
							</div>


							<div class="col-md-9">
								<div class="panel panel-default">
									<div class="panel-heading">
										<h4>
											Latest Activity<a class="fa fa-refresh pull-right"
												value="Refresh" onclick="javascript:showlocation()"
												href="javascript:;" />
										</h4>
									</div>
									<ul id="conversationDiv" class="list-group">
										<p id="response"></p>
									</ul>
								</div>
							</div>
							<div style="visibility: hidden">
								<li class="message list-group-item">
									<div class="message-header">
										<span class="author">Author</span> <span class="time">time</span>
										<span class="distance">distance</span>
									</div> <span class="body">body</span>
								</li>
							</div>
						</div>
					</div>
				</div>
				<div style="visibility: hidden">
					<br />

					<div style="visibility: hidden">
						Latitude: <span id="latitude"></span> <br /> Longitude: <span
							id="longitude"></span>
					</div>
				</div>
			</div>
		</div>
	</div>
	
</body>
</html>